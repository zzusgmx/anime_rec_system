{% extends 'base.html' %}
{% load static %}

{% block title %}社区分析 - 量子级动漫推荐系统{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'visualizations/css/data-dashboard.css' %}">
<link rel="stylesheet" href="{% static 'visualizations/css/charts.css' %}">
<style>
  .user-card {
    transition: transform 0.3s;
    position: relative;
    overflow: hidden;
  }
  .user-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.1);
  }
  .user-rank {
    position: absolute;
    top: 0;
    left: 0;
    background-color: #6d28d9;
    color: white;
    width: 30px;
    height: 30px;
    border-radius: 0 0 8px 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
  }
  .user-avatar {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid #f1f5f9;
  }
  .network-container {
    width: 100%;
    height: 600px;
    background-color: #f8fafc;
    border-radius: 8px;
    position: relative;
  }
  .network-controls {
    position: absolute;
    top: 10px;
    left: 10px;
    z-index: 100;
    background-color: rgba(255, 255, 255, 0.9);
    padding: 10px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }
  .network-legend {
    position: absolute;
    bottom: 10px;
    right: 10px;
    z-index: 100;
    background-color: rgba(255, 255, 255, 0.9);
    padding: 10px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }
  .legend-item {
    display: flex;
    align-items: center;
    margin-bottom: 5px;
  }
  .legend-color {
    width: 15px;
    height: 15px;
    border-radius: 50%;
    margin-right: 8px;
  }
  .discussion-activity {
    height: 40px;
    background-color: #e2e8f0;
    border-radius: 4px;
    overflow: hidden;
  }
  .activity-bar {
    height: 100%;
    background-color: #6d28d9;
    display: flex;
    align-items: center;
    padding: 0 10px;
    color: white;
    font-size: 12px;
  }
</style>
{% endblock %}

{% block content %}
<div class="quantum-dashboard" data-theme="{{ preferences.theme|default:'quantum' }}">
  <div class="container py-4">
    <!-- 标题区域 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h1 class="mb-1">社区分析</h1>
        <p class="text-muted">探索用户互动和社区趋势</p>
      </div>

      <div>
        <a href="{% url 'visualizations:dashboard' %}" class="btn btn-outline-primary">
          <i class="fas fa-arrow-left me-1"></i>返回仪表盘
        </a>
      </div>
    </div>

    <!-- 导航标签 -->
    <ul class="nav nav-pills mb-4">
      <li class="nav-item">
        <a class="nav-link active" id="overview-tab" data-bs-toggle="pill" href="#overview">社区概览</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="users-tab" data-bs-toggle="pill" href="#users">用户分析</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="discussions-tab" data-bs-toggle="pill" href="#discussions">讨论热度</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="network-tab" data-bs-toggle="pill" href="#network">社交网络</a>
      </li>
    </ul>

    <!-- 标签内容 -->
    <div class="tab-content">
      <!-- 社区概览标签 -->
      <div class="tab-pane fade show active" id="overview">
        <!-- 社区统计卡片 -->
        <div class="row">
          <div class="col-md-3 col-sm-6 mb-4">
            <div class="quantum-card">
              <div class="quantum-card-title">
                <span><i class="fas fa-users"></i>活跃用户</span>
              </div>
              <div class="quantum-card-content d-flex align-items-center justify-content-center">
                <div class="text-center">
                  <div class="display-4 fw-bold">{{ community_stats.active_users_count }}</div>
                  <div class="text-muted">位用户</div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-md-3 col-sm-6 mb-4">
            <div class="quantum-card">
              <div class="quantum-card-title">
                <span><i class="fas fa-comment"></i>评论总数</span>
              </div>
              <div class="quantum-card-content d-flex align-items-center justify-content-center">
                <div class="text-center">
                  <div class="display-4 fw-bold">{{ community_stats.comment_count }}</div>
                  <div class="text-muted">条评论</div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-md-3 col-sm-6 mb-4">
            <div class="quantum-card">
              <div class="quantum-card-title">
                <span><i class="fas fa-heart"></i>互动总数</span>
              </div>
              <div class="quantum-card-content d-flex align-items-center justify-content-center">
                <div class="text-center">
                  <div class="display-4 fw-bold">{{ community_stats.interaction_count }}</div>
                  <div class="text-muted">次互动</div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-md-3 col-sm-6 mb-4">
            <div class="quantum-card">
              <div class="quantum-card-title">
                <span><i class="fas fa-fire"></i>热门话题</span>
              </div>
              <div class="quantum-card-content d-flex align-items-center justify-content-center">
                <div class="text-center">
                  <div class="display-4 fw-bold">{{ community_stats.hot_topics_count }}</div>
                  <div class="text-muted">个话题</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 活动趋势图 -->
        <div class="row mb-4">
          <div class="col-12">
            <div class="quantum-card">
              <div class="quantum-card-title">
                <span><i class="fas fa-chart-line"></i>社区活动趋势</span>
              </div>
              <div class="quantum-card-content">
                <div id="community-activity-chart" class="chart-container" style="height: 400px"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- 用户和讨论预览 -->
        <div class="row">
          <div class="col-md-6 mb-4">
            <div class="quantum-card">
              <div class="quantum-card-title">
                <span><i class="fas fa-trophy"></i>最活跃用户</span>
                <a href="#users" class="card-link text-primary" data-bs-toggle="pill" data-bs-target="#users">查看更多</a>
              </div>
              <div class="quantum-card-content">
                <div class="list-group list-group-flush">
                  {% for user in active_users|slice:":5" %}
                  <div class="list-group-item d-flex align-items-center">
                    <div class="me-3">
                      {% if user.avatar %}
                      <img src="{{ user.avatar.url }}" alt="{{ user.user.username }}" class="rounded-circle" width="40" height="40">
                      {% else %}
                      <div class="bg-light rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                        <i class="fas fa-user text-secondary"></i>
                      </div>
                      {% endif %}
                    </div>
                    <div class="flex-grow-1">
                      <div class="fw-bold">{{ user.user.username }}</div>
                      <div class="small text-muted">活跃度: {{ user.social_activity_score }}</div>
                    </div>
                  </div>
                  {% empty %}
                  <div class="list-group-item text-center py-4">
                    <i class="fas fa-info-circle text-muted me-2"></i>暂无活跃用户数据
                  </div>
                  {% endfor %}
                </div>
              </div>
            </div>
          </div>

          <div class="col-md-6 mb-4">
            <div class="quantum-card">
              <div class="quantum-card-title">
                <span><i class="fas fa-fire"></i>热门讨论</span>
                <a href="#discussions" class="card-link text-primary" data-bs-toggle="pill" data-bs-target="#discussions">查看更多</a>
              </div>
              <div class="quantum-card-content">
                <div class="list-group list-group-flush">
                  {% for anime in hot_discussions|slice:":5" %}
                  <div class="list-group-item">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                      <a href="{% url 'anime:anime_detail' anime.id %}" class="text-decoration-none text-dark fw-bold">{{ anime.title }}</a>
                      <span class="badge bg-primary">{{ anime.comment_count }} 条评论</span>
                    </div>
                    <div class="small text-muted">最新讨论: {{ anime.latest_comment_date|date:"Y-m-d H:i" }}</div>
                  </div>
                  {% empty %}
                  <div class="list-group-item text-center py-4">
                    <i class="fas fa-info-circle text-muted me-2"></i>暂无热门讨论数据
                  </div>
                  {% endfor %}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 用户分析标签 -->
      <div class="tab-pane fade" id="users">
        <div class="row mb-4">
          <div class="col-md-6">
            <div class="quantum-card">
              <div class="quantum-card-title">
                <span><i class="fas fa-chart-pie"></i>用户活跃度分布</span>
              </div>
              <div class="quantum-card-content">
                <div id="user-activity-distribution-chart" class="chart-container" style="height: 300px"></div>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="quantum-card">
              <div class="quantum-card-title">
                <span><i class="fas fa-chart-pie"></i>用户影响力分布</span>
              </div>
              <div class="quantum-card-content">
                <div id="user-influence-distribution-chart" class="chart-container" style="height: 300px"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="row mb-4">
          <!-- 最活跃用户 -->
          <div class="col-12 mb-3">
            <h3>最活跃用户</h3>
          </div>

          {% for user in active_users %}
          <div class="col-md-3 col-sm-6 mb-4">
            <div class="quantum-card user-card">
              <div class="user-rank">{{ forloop.counter }}</div>
              <div class="p-3 text-center">
                {% if user.avatar %}
                <img src="{{ user.avatar.url }}" alt="{{ user.user.username }}" class="user-avatar mb-3">
                {% else %}
                <div class="user-avatar mx-auto mb-3 bg-light d-flex align-items-center justify-content-center">
                  <i class="fas fa-user fa-2x text-secondary"></i>
                </div>
                {% endif %}
                <h5 class="mb-1">{{ user.user.username }}</h5>
                <div class="text-muted mb-3">活跃度: {{ user.social_activity_score }}</div>
                <div class="d-flex justify-content-around">
                  <div class="text-center">
                    <div class="fw-bold">{{ user.user_comment_count }}</div>
                    <small class="text-muted">评论</small>
                  </div>
                  <div class="text-center">
                    <div class="fw-bold">{{ user.user_rating_count }}</div>
                    <small class="text-muted">评分</small>
                  </div>
                  <div class="text-center">
                    <div class="fw-bold">{{ user.user_like_count }}</div>
                    <small class="text-muted">点赞</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
          {% empty %}
          <div class="col-12">
            <div class="alert alert-info">暂无活跃用户数据</div>
          </div>
          {% endfor %}
        </div>

        <div class="row">
          <!-- 最具影响力用户 -->
          <div class="col-12 mb-3">
            <h3>最具影响力用户</h3>
          </div>

          {% for user in influential_users %}
          <div class="col-md-3 col-sm-6 mb-4">
            <div class="quantum-card user-card">
              <div class="user-rank">{{ forloop.counter }}</div>
              <div class="p-3 text-center">
                {% if user.avatar %}
                <img src="{{ user.avatar.url }}" alt="{{ user.user.username }}" class="user-avatar mb-3">
                {% else %}
                <div class="user-avatar mx-auto mb-3 bg-light d-flex align-items-center justify-content-center">
                  <i class="fas fa-user fa-2x text-secondary"></i>
                </div>
                {% endif %}
                <h5 class="mb-1">{{ user.user.username }}</h5>
                <div class="text-muted mb-3">影响力: {{ user.influence_score }}</div>
                <div class="d-flex justify-content-around">
                  <div class="text-center">
                    <div class="fw-bold">{{ user.follower_count }}</div>
                    <small class="text-muted">粉丝</small>
                  </div>
                  <div class="text-center">
                    <div class="fw-bold">{{ user.helpful_count }}</div>
                    <small class="text-muted">被赞</small>
                  </div>
                  <div class="text-center">
                    <div class="fw-bold">{{ user.mention_count }}</div>
                    <small class="text-muted">被提及</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
          {% empty %}
          <div class="col-12">
            <div class="alert alert-info">暂无影响力用户数据</div>
          </div>
          {% endfor %}
        </div>
      </div>

      <!-- 讨论热度标签 -->
      <div class="tab-pane fade" id="discussions">
        <div class="row mb-4">
          <div class="col-md-6">
            <div class="quantum-card">
              <div class="quantum-card-title">
                <span><i class="fas fa-chart-bar"></i>不同类型讨论热度</span>
              </div>
              <div class="quantum-card-content">
                <div id="discussion-by-genre-chart" class="chart-container" style="height: 300px"></div>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="quantum-card">
              <div class="quantum-card-title">
                <span><i class="fas fa-chart-line"></i>讨论趋势</span>
              </div>
              <div class="quantum-card-content">
                <div id="discussion-trend-chart" class="chart-container" style="height: 300px"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="row">
          <!-- 热门讨论的动漫 -->
          <div class="col-12 mb-3">
            <h3>热门讨论的动漫</h3>
          </div>

          {% for anime in hot_discussions %}
          <div class="col-md-6 mb-4">
            <div class="quantum-card h-100">
              <div class="p-3">
                <div class="d-flex justify-content-between align-items-start">
                  <div>
                  <h5 class="mb-1"><a href="{% url 'anime:anime_detail' anime.id %}" class="text-decoration-none text-dark">{{ anime.title }}</a></h5>
                    <div class="text-muted mb-2">评分: {{ anime.rating_avg|default:"暂无" }} |
                      {% if anime.type %}
                      <span class="badge bg-primary">{{ anime.type.name }}</span>
                      {% endif %}
                    </div>
                  </div>
                  <span class="badge bg-info">{{ anime.comment_count }} 条评论</span>
                </div>

                <div class="mt-3">
                  <div class="text-muted small mb-1">讨论热度</div>
                  <div class="discussion-activity">
                    <div class="activity-bar" style="width: {{ anime.discussion_percentage }}%">
                      {{ anime.discussion_percentage }}%
                    </div>
                  </div>
                </div>

                {% if anime.top_comment %}
                <div class="mt-3">
                  <div class="text-muted small mb-1">热门评论</div>
                  <div class="card bg-light">
                    <div class="card-body py-2">
                      <div class="d-flex">
                        <div class="flex-grow-1">
                          <p class="mb-1">{{ anime.top_comment.content|truncatechars:100 }}</p>
                          <small class="text-muted">— {{ anime.top_comment.user.username }}</small>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                {% endif %}
              </div>
            </div>
          </div>
          {% empty %}
          <div class="col-12">
            <div class="alert alert-info">暂无热门讨论数据</div>
          </div>
          {% endfor %}
        </div>
      </div>

      <!-- 社交网络标签 -->
      <div class="tab-pane fade" id="network">
        <div class="row mb-4">
          <div class="col-12">
            <div class="quantum-card">
              <div class="quantum-card-title">
                <span><i class="fas fa-project-diagram"></i>用户交互网络</span>
              </div>
              <div class="quantum-card-content p-0">
                <div class="network-container">
                  <div class="network-controls">
                    <div class="form-check form-switch mb-2">
                      <input class="form-check-input" type="checkbox" id="userFocusedToggle" checked>
                      <label class="form-check-label" for="userFocusedToggle">以我为中心</label>
                    </div>
                    <select class="form-select form-select-sm" id="interactionTypeSelect">
                      <option value="all" selected>所有互动</option>
                      <option value="like">点赞</option>
                      <option value="reply">回复</option>
                      <option value="mention">提及</option>
                    </select>
                  </div>

                  <div id="network-visualization"></div>

                  <div class="network-legend">
                    <div class="mb-2 fw-bold">图例</div>
                    <div class="legend-item">
                      <div class="legend-color" style="background-color: #6d28d9;"></div>
                      <div>用户</div>
                    </div>
                    <div class="legend-item">
                      <div class="legend-color" style="background-color: #ef4444;"></div>
                      <div>点赞关系</div>
                    </div>
                    <div class="legend-item">
                      <div class="legend-color" style="background-color: #3b82f6;"></div>
                      <div>回复关系</div>
                    </div>
                    <div class="legend-item">
                      <div class="legend-color" style="background-color: #10b981;"></div>
                      <div>提及关系</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="row mb-4">
          <div class="col-md-6">
            <div class="quantum-card">
              <div class="quantum-card-title">
                <span><i class="fas fa-chart-pie"></i>互动类型分布</span>
              </div>
              <div class="quantum-card-content">
                <div id="interaction-type-chart" class="chart-container" style="height: 300px"></div>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="quantum-card">
              <div class="quantum-card-title">
                <span><i class="fas fa-chart-line"></i>互动趋势</span>
              </div>
              <div class="quantum-card-content">
                <div id="interaction-trend-chart" class="chart-container" style="height: 300px"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{% static 'visualizations/js/visualization-core.js' %}"></script>
<script src="{% static 'visualizations/js/trend-visualizer.js' %}"></script>
<script src="{% static 'visualizations/js/network-charts.js' %}"></script>
<script src="{% static 'visualizations/js/visualization-manager.js' %}"></script>
<!-- 添加修复"查看更多"按钮的脚本 -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // 通用函数：激活指定标签页
  function activateTab(tabId) {
    // 查找标签页元素
    const tabEl = document.getElementById(tabId);
    if (!tabEl) return;

    // 检查Bootstrap是否可用
    if (typeof bootstrap !== 'undefined' && typeof bootstrap.Tab !== 'undefined') {
      // 使用Bootstrap API
      const tab = new bootstrap.Tab(tabEl);
      tab.show();
    } else {
      // 手动激活标签页
      // 1. 停用所有标签页
      document.querySelectorAll('.nav-link').forEach(el => {
        el.classList.remove('active');
      });
      document.querySelectorAll('.tab-pane').forEach(el => {
        el.classList.remove('show', 'active');
      });

      // 2. 激活目标标签页
      tabEl.classList.add('active');
      const targetPane = document.querySelector(tabEl.getAttribute('href') || tabEl.getAttribute('data-bs-target'));
      if (targetPane) {
        targetPane.classList.add('show', 'active');
      }
    }
  }

  // 修复"查看更多"按钮的点击事件处理程序
  document.querySelectorAll('[data-bs-toggle="pill"][data-bs-target="#users"], [data-bs-toggle="pill"][data-bs-target="#discussions"]').forEach(button => {
    button.addEventListener('click', function(event) {
      // 阻止默认行为
      event.preventDefault();

      // 获取目标标签页ID
      const targetId = this.getAttribute('data-bs-target').substring(1) + '-tab';

      // 激活目标标签页
      activateTab(targetId);
    });
  });
});
</script>
{% endblock %}